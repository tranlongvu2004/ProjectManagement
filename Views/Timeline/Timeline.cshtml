<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<style>

    .jira-legend-item {
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .jira-legend-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
    }

</style>
<div class="d-flex justify-content-between align-items-center mb-3">
    @{
        var projectId = ViewBag.ProjectId;
    }
        <a href="/Backlog/BacklogUI?projectId=@projectId"
           class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Backlog
        </a>
    </div>
<div id="calendar"></div>

<div id="calendarLegend"
     class="d-flex flex-wrap gap-4 mt-3 text-muted small align-items-center">
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {


            const tasks = @Html.Raw(ViewBag.Tasks);

            const status = {
            "Not_Started": "#9e9e9e",
            "Doing": "#2196f3",
            "Completed": "#4caf50",
            "Stuck": "#ff5722",
            "ToDo": "#ab47bc"
            };

            const events = tasks.map(t => ({
                    id: t.TaskId,
                    title: t.Title,
                    owner: t.Owner,
                    start: toDateOnly(t.Start),
                    end: addOneDay(t.End),
                    status: t.Status,
                    backgroundColor: status[t.Status] || "#607d8b",
                    borderColor: status[t.Status] || "#607d8b",
                    allDay: true
            }));
            var calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
            initialView: 'dayGridMonth',
            events: events,
            eventDidMount(info) {

                 const start = info.event.start;

                let end = info.event.end;
                if (end) {
                    end = new Date(end);
                    end.setDate(end.getDate() - 1);
                }

                info.el.title =
                    info.event.title +
                    " | " +
                    start.toLocaleDateString() +
                    " → " +
                    (end ? end.toLocaleDateString() : "");
            }

        });

        calendar.render();

        const usedStatuses = [...new Set(events.map(e => e.status))];
        const legend = document.getElementById("calendarLegend");

        usedStatuses.forEach(st => {
            if (!status[st]) return;

            const item = document.createElement("div");
            item.className = "jira-legend-item";

            item.innerHTML = `
                <span class="jira-legend-dot" style="background:${status[st]}"></span>
                <span>${st.replace("_", " ")}</span>
            `;

            legend.appendChild(item);
        });

            function toDateOnly(dateStr) {
        return dateStr.split('T')[0];
    }

        function addOneDay(dateStr) {
        const d = new Date(dateStr);
        d.setDate(d.getDate() + 1);
        return d.toISOString().split('T')[0];
    }

    console.table(events.map(e => ({
        title: e.title,
        start: e.start,
        end: e.end,
        status: e.status
    })));

    });

        


</script>
