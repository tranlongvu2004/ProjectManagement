@model PorjectManagement.ViewModels.AddMembersViewModel
@{
    ViewData["Title"] = "Add Members";
}



<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<style>

   
    .card {
        border: none;
        border-radius: 18px;
        box-shadow: 0 6px 18px rgba(0,0,0,0.08);
        overflow: hidden;
    }

    .table {
        margin-bottom: 0;
    }

    table thead {
        background: #f3f6fb;
        font-weight: 600;
        font-size: 14px;
    }

        table thead th {
            padding: 14px 18px;
            color: #4a4f5c;
            border-bottom: 1px solid #e2e6ef;
        }

    .user-row {
        transition: 0.15s ease-in-out;
    }

        .user-row:hover {
            background: #eef4ff !important;
        }

    .user-check,
    #selectAll {
        transform: scale(1.25);
        cursor: pointer;
    }

    .rounded-circle {
        background: linear-gradient(135deg, #5673ff, #3a56ff) !important;
        color: #fff;
        font-weight: 600;
        font-size: 15px;
        width: 40px;
        height: 40px;
    }

    .fw-bold {
        font-size: 15px;
        color: #222;
    }
    .progress {
        background: #e6ebf4 !important;
        border-radius: 14px;
        height: 8px;
    }

    .progress-bar {
        background: #5277ff !important;
        border-radius: 14px;
    }

    .badge {
        padding: 6px 12px;
        font-size: 12px;
        border-radius: 14px;
        font-weight: 600;
    }

        .badge.bg-success {
            background-color: #d8f7de !important;
            color: #2c8d55 !important;
        }

        .badge.bg-primary {
            background-color: #e1e7ff !important;
            color: #3955ff !important;
        }

        .badge.bg-secondary {
            background-color: #ececec !important;
            color: #555 !important;
        }

        .badge.bg-warning.text-dark {
            background-color: #ffe9b6 !important;
            color: #7a5a00 !important;
        }

    #projectSelect {
        border-radius: 12px;
        padding: 10px 14px;
        height: 48px;
        border: 1px solid #d4dae5;
        transition: 0.2s;
    }

        #projectSelect:focus {
            border-color: #4d6bff;
            box-shadow: 0 0 0 3px rgba(71, 99, 255, 0.25);
        }

    #searchBox {
        border-radius: 12px;
        padding: 10px 14px;
        width: 360px;
        border: 1px solid #d4dae5;
        transition: 0.2s;
    }

        #searchBox:focus {
            border-color: #3d73ff;
            box-shadow: 0 0 0 3px rgba(61,115,255,0.25);
        }

    button.btn-primary {
        background: #3d6bff !important;
        border: none;
        padding: 11px 22px;
        font-size: 15px;
        border-radius: 12px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(61,115,255,0.3);
        transition: 0.15s ease-in-out;
    }

        button.btn-primary:hover {
            background: #2858ff !important;
            transform: translateY(-2px);
        }

    .btn-outline-secondary {
        padding: 10px 20px;
        border-radius: 12px;
    }

    #selectedCount {
        font-weight: 600;
        color: #3d4a63;
        font-size: 14px;
    }

    .alert {
        border-radius: 14px;
        padding: 16px 18px;
        font-size: 14px;
    }


</style>

<div class="container my-4">

    <div class="mb-3">
        <label class="form-label fw-bold">Chọn dự án</label>
        <select id="projectSelect" class="form-select" onchange="onProjectChange()">
            <option value="">-- Chọn dự án --</option>
            @if (Model.AllProjects != null)
            {
                foreach (var p in Model.AllProjects)
                {
                    <option value="@p.ProjectId" selected="@(Model.ProjectId == p.ProjectId)">
                        @p.ProjectName
                    </option>
                }
            }
        </select>
    </div>


    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Thêm thành viên vào dự án: @Model.ProjectName</h3>


        <form class="d-flex" method="get" action="">
            <input id="searchBox" class="form-control me-2" type="search" placeholder="Tìm theo tên của thực tập sinh" aria-label="Search">
        </form>
    </div>

    <form id="addForm" asp-controller="UserProject" asp-action="AddMembers" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="ProjectId" />

        <div class="card">
            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th style="width:40px;"><input id="selectAll" type="checkbox" /></th>
                            <th>Tên thực tập sinh</th>
                            <th>Gmail</th>
                            <th>Ngày bắt đầu</th>
                            <th>Role</th>
                            <th>Trạng thái</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
    @for (int i = 0; i < Model.Users.Count; i++)
    {
        var u = Model.Users[i];
        <tr class="user-row" data-name="@u.FullName.ToLower()">

            <td>
                <input class="form-check-input user-check"
                       name="SelectedUserIds"
                       type="checkbox"
                       value="@u.UserId" />
            </td>

            <td>
                <div class="d-flex align-items-center">
                    <div class="rounded-circle bg-secondary me-2"
                         style="width:38px;height:38px;
                                display:flex;align-items:center;
                                justify-content:center;color:white;">
                        @u.FullName.Split(' ').Last().Substring(0,1).ToUpper()
                    </div>
                    <div>
                        <div class="fw-bold">@u.FullName</div>
                    </div>
                </div>
            </td>

            <td>@u.Email</td>

            <td>
                @(u.CreatedAt.HasValue
                    ? u.CreatedAt.Value.ToString("dd/MM/yyyy")
                    : "")
                                                                     <td>
                                                                         <span class="badge
            @(u.RoleName == "Mentor" ? "bg-primary" :
                                                    u.RoleName == "InternLead" ? "bg-warning text-dark" :
                                                    "bg-secondary")">
                                    @u.RoleName
                                </span>
                            </td>

            <td>
                @switch (u.Status)
                {
                    case "active":
                        <span class="badge bg-success">Đang thực tập</span>;
                        break;

                    case "inactive":
                        <span class="badge bg-primary">Không tồn tại</span>;
                        break;
                    case "dropped":
                        <span class="badge bg-primary">Đã ngừng hoạt động</span>;
                        break;

                    default:
                        <span class="badge bg-secondary">@u.Status</span>;
                        break;
                }
            </td>

        </tr>
    }

</tbody>
                    @if (TempData["AddResults"] != null)
                    {
                        var results = System.Text.Json.JsonSerializer.Deserialize<Dictionary<int, string>>(TempData["AddResults"].ToString());

                        <div class="alert alert-info">
                            @foreach (var r in results)
                            {
                                <p>
                                    User ID @r.Key:
                                    @{
                                        string msg = r.Value switch
                                        {
                                            "success" => "Thêm thành công",
                                            "exists" => " Đã tồn tại trong dự án",
                                            "invalid_status" => "Không thể thêm: thực tập sinh không tồn tại",
                                            _ => "Không xác định"
                                        };
                                    }
                                    @msg
                                </p>
                            }
                        </div>
                    }
                    @if (TempData["Info"] != null)
                    {
                        <div class="alert alert-danger mt-3">
                            @TempData["Info"]
                        </div>
                    }




                </table>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <span id="selectedCount">0 thực tập sinh đã được chọn</span>
            </div>
            <div>
                <a asp-controller="Home" asp-action="Index"
                   class="btn btn-outline-secondary me-2">Hủy</a>
                <button type="submit" class="btn btn-primary">Thêm (<span id="addCount">0</span>)</button>
            </div>
        </div>
    </form>
</div>

<script>
    function onProjectChange() {
            const id = document.getElementById("projectSelect").value;
            if (id) {
                window.location.href = "/UserProject/AddMembers?id=" + id;
            }
        }
    (function () {
        const selectAll = document.getElementById('selectAll');
        const checks = document.querySelectorAll('.user-check');
        const selectedCountSpan = document.getElementById('selectedCount');
        const addCountSpan = document.getElementById('addCount');
        const searchBox = document.getElementById('searchBox');

        function updateCounts() {
            const checked = document.querySelectorAll('.user-check:checked').length;
            selectedCountSpan.textContent = `${checked} thực tập sinh đã được chọn`;
            addCountSpan.textContent = checked;
        }

        selectAll.addEventListener('change', function () {
            checks.forEach(c => c.checked = selectAll.checked);
            updateCounts();
        });

        checks.forEach(c => c.addEventListener('change', function () {
            if (!this.checked) {
                selectAll.checked = false;
            } else {
                if (document.querySelectorAll('.user-check:not(:checked)').length === 0) {
                    selectAll.checked = true;
                }
            }
            updateCounts();
        }));

        searchBox.addEventListener('input', function () {
            const q = this.value.trim().toLowerCase();
            const rows = document.querySelectorAll('.user-row');
            rows.forEach(r => {
                const name = r.getAttribute('data-name') ?? '';
                const role = r.getAttribute('data-role') ?? '';
                   if (!q || name.includes(q) || role.includes(q)) {
        r.style.display = '';
    } else {
        r.style.display = 'none';
    }

            });
            updateCounts();
        });

        updateCounts();
    })();
     document.getElementById("addForm").addEventListener("submit", function (e) {
        const project = document.getElementById("projectSelect").value;
        const checked = document.querySelectorAll(".user-check:checked").length;

        if (!project) {
            e.preventDefault();
            alert("Bạn cần chọn một dự án!");
            return;
        }

        if (checked === 0) {
            e.preventDefault();
            alert("Bạn phải chọn ít nhất 1 thực tập sinh!");
        }
    });
</script>


