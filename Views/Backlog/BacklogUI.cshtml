@using PorjectManagement.Models
@model List<PorjectManagement.Models.Task>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success">
        @TempData["SuccessMessage"]
    </div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">
        @TempData["Error"]
    </div>
}

@{
    ViewData["Title"] = "Main Table";
    var projectId = ViewBag.ProjectId;
    var roleId = Context.Session.GetInt32("RoleId") ?? 0;
    var userId = Context.Session.GetInt32("UserId") ?? 0;
    bool isLeader = ViewBag.isLeader ?? false;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>

    /* TABLE BORDER & SHADOW */
.table {
    border-collapse: separate;
    border-spacing: 0;
    background: #fff;
    border-radius: 10px;
    overflow: hidden;
}

/* Header */
.table thead th {
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    white-space: nowrap;
}

/* Row border */
.table tbody tr {
    border-bottom: 1px solid #e9ecef;
}

/* Hover effect */
.table tbody tr:hover {
    background-color: #f9fbfd;
}

/* Parent task */
.parent-row {
    background-color: #ffffff;
    font-weight: 500;
}

/* Subtask */
.subtask-row {
    background-color: #fafafa;
    border-left: 4px solid #e9ecef;
}

/* Cell padding */
.table td, .table th {
    vertical-align: middle;
    padding: 12px;
}


    .dashboard-btn {
        padding: 8px 16px;
        background: linear-gradient(135deg, #4c6ef5, #3b5bdb);
        color: white !important;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        border: none;
        transition: 0.25s ease;
    }

        .dashboard-btn:hover {
            background: linear-gradient(135deg, #364fc7, #2f44ad);
            color: #e9ecef !important;
            transform: translateY(-2px);
            box-shadow: 0px 4px 10px rgba(0,0,0,0.2);
        }

        .dashboard-btn i {
            font-size: 14px;
        }

    .search-hidden {
        display: none !important;
    }

    .btn-edit {
        background-color: white;
        color: black;
        border: 2px solid black;
        border-radius: 6px;
        font-weight: 500;
        padding: 4px 12px;
        transition: all 0.2s ease;
    }

        .btn-edit:hover {
            background-color: black;
            color: white;
            border-color: black;
        }

        .btn-edit i {
            font-size: 13px;
        }

    .btn-assign-task {
        background-color: #0d6efd;
        color: white;
        border-radius: 6px;
        padding: 4px 12px;
        font-weight: 500;
        border: none;
        transition: 0.2s;
    }

        .btn-assign-task:hover {
            background-color: #0b5ed7;
            color: white;
        }

        .summary-bar {
    display: flex;
    height: 14px;
    border-radius: 8px;
    overflow: hidden;
    background: #e9ecef;
}

.summary-segment {
    height: 100%;
}

.output-cell {
    max-width: 260px;
}

.output-list {
    max-height: 80px;
    overflow-y: auto;
}

.output-item a {
    display: inline-block;
    max-width: 220px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    vertical-align: middle;
}


</style>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Main Table</h3>
        <a asp-controller="Workspace" asp-action="Details" asp-route-id="@projectId" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Workspace
        </a>
    </div>

    <!-- Tool bar -->
    <div class="d-flex gap-2 my-3">
        <div>
            <button id="btnSearch" class="btn btn-light border">
                <i class="fa fa-search"></i>Search
            </button>
            <input id="searchInput" type="text" class="form-control form-control-sm search-hidden" placeholder="Type to search" />
        </div>

        <!-- ⭐ Nút Add Member -->
        <!-- Có quyền -->
        @if (roleId == 2)
        {
            <a class="btn btn-primary" href="@Url.Action("AddMembers", "UserProject", new { projectId = ViewBag.ProjectId })">
                <i class="fa fa-user-plus"></i> Add Member
            </a>
        }

        @if (ViewBag.isLeader == true)
        {
            <a class="btn btn-success" href="@Url.Action("CreateTask", "Task", new { id = ViewBag.ProjectId })">
                <i class="bi bi-plus-circle"></i> Create Task
            </a>
            <a href="/Report/ViewReport?projectId=@projectId" class="dashboard-btn">
                <i class="fa fa-chart-line"></i> View Report
            </a>
        }

        <a href="/Timeline/Timeline?projectId=@projectId" class="dashboard-btn">
            <i class="fa fa-chart-line"></i> Calendar
        </a>

        <a href="/RecycleBin/RecycleBin" class="dashboard-btn">
            <i class="fa fa-chart-line"></i> Recycle Bin
        </a>
    </div>

    <table class="table align-middle shadow-sm">
        <thead class="table-light">
            <tr>
                <th>Task</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Deadline</th>
                <th>Priority</th>
                <th>Action</th>
                <th>Output resource</th>
            </tr>
        </thead>
        <tbody>
            @{
                var subTasks = ViewBag.SubTasks as List<PorjectManagement.Models.Task>;
            }

            @foreach (var parent in ViewBag.ParentTasks as List<PorjectManagement.Models.Task>)
            {
                var hasSubTasks = subTasks.Any(c => c.ParentId == parent.TaskId);

                <tr class="parent-row" data-id="@parent.TaskId">
                    <td>
                        <span class="toggle-btn" data-target="@parent.TaskId" style="cursor:pointer;">
                            ▶
                        </span>
                        <strong>@parent.Title</strong>
                    </td>
                    <td>
                        @foreach (var o in parent.TaskAssignments)
                        {
                            <img src="@o.User.AvatarUrl"
                                 style="width:32px;height:32px;object-fit:cover;border-radius:50%;margin-right:4px;"
                                 title="@o.User.FullName" />
                        }
                    </td>
                    <td>
                        @{
                            var statusParent = parent.Status switch
                        {
                                PorjectManagement.Models.TaskStatus.ToDo          => "bg-primary",
                                PorjectManagement.Models.TaskStatus.Doing        => "bg-warning text-dark",
                                PorjectManagement.Models.TaskStatus.Completed    => "bg-success",
                                PorjectManagement.Models.TaskStatus.Stuck        => "bg-danger",
                                PorjectManagement.Models.TaskStatus.Not_Started  => "bg-secondary",
                                _ => "bg-light text-dark"
                         };
                        }

                                    <span class="badge @statusParent">
                                        @parent.Status
                                    </span>

                    </td>
                    <td>@parent.Deadline?.ToString("MMM d")</td>
                    <td>
                        @{

                            var priorityParent = parent.Priority switch 
                            {
                                PorjectManagement.Models.TaskPriority.Low       => "bg-primary", 
                                PorjectManagement.Models.TaskPriority.Medium    => "bg-warning text-dark", 
                                PorjectManagement.Models.TaskPriority.High      => "bg-dark",
                                PorjectManagement.Models.TaskPriority.Necessary => "bg-danger",
                                _ => "bg-light text-dark"
                            };

                        }
                                  <span class="badge @priorityParent">
                                     @parent.Priority
                                </span>
                        </td>
                    
                        <td>
                            @if(roleId == 2)
                    {
                        <a asp-controller="Task" asp-action="Edit" asp-route-id="@parent.TaskId"
                           class="btn btn-sm btn-edit">
                            <i class="bi bi-pencil-fill"></i>
                        </a>

                        <!-- ASSIGN -->
                        <a asp-controller="Task" asp-action="Assign" asp-route-id="@parent.TaskId"
                           class="btn btn-sm btn-assign-task">
                            <i class="bi bi-person-plus"></i>
                        </a>

                        <button class="btn btn-sm btn-outline-primary upload-btn"
                                data-task-id="@parent.TaskId"
                                data-bs-toggle="modal"
                                data-bs-target="#uploadModal">
                            <i class="bi bi-upload"></i>
                        </button>

                            <button class="btn btn-sm btn-warning delete-btn"
                                    data-task-id="@parent.TaskId"
                                    data-task-name="@parent.Title">
                                <i class="bi bi-trash"></i>
                            </button>
                    }
                        <!-- 🆕 COMMENT BUTTON - PARENT TASK -->
                        <button class="btn btn-sm btn-info comment-btn"
                                data-task-id="@parent.TaskId"
                                data-task-name="@parent.Title"
                                data-bs-toggle="modal"
                                data-bs-target="#commentModal">
                            <i class="bi bi-chat-dots"></i> (@parent.Comments.Count)
                        </button>
                    </td>
                    
                    
                        
                    
                    <td class="output-cell">
                    @if (parent.TaskAttachments != null && parent.TaskAttachments.Any())
                    {
                        <div class="output-list">
                            @foreach (var att in parent.TaskAttachments.Take(2))
                            {
                                <div class="output-item">
                                     <a href="@att.FilePath" target="_blank" title="@att.FileName">
                                        📎
                                    </a>
                                </div>
                            }

                            @if (parent.TaskAttachments.Count > 2)
                            {
                                <small class="text-muted">
                                    +@(parent.TaskAttachments.Count - 2) more
                                </small>
                            }
                        </div>
                            @if (roleId == 2)
                            {
                                <!-- Delete -->
                                <form asp-controller="Task"
                                asp-action="DeleteAttachment"
                                method="post"
                                class="d-inline">
                                    <input type="hidden" name="taskId" value="@parent.TaskId" />

                                    <button type="submit"
                                    class="btn btn-sm btn-outline-danger"
                                    title="Delete attachment"
                                    onclick="return confirm('Delete attachment?');">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </form>


                                <!-- Replace -->
                                <form asp-controller="Task"
                                asp-action="ReplaceAttachment"
                                  method="post"
                                  enctype="multipart/form-data"
                                  class="d-inline">
                                <input type="hidden" name="taskId" value="@parent.TaskId" />

                                <label class="btn btn-sm btn-outline-warning mb-0" title="Replace attachment">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    <input type="file"
                                           name="file"
                                           hidden
                                           onchange="this.form.submit()" />
                                </label>
                            </form>
                            }
                    }
                    else
                    {
                        <span class="text-muted">No attachment</span>
                    }

                    

                </td>

                </tr>

                <!-- SUBTASKS -->
                @foreach (var child in (ViewBag.SubTasks as List<PorjectManagement.Models.Task>)
                            .Where(c => c.ParentId == parent.TaskId))
                {
                    <tr class="subtask-row subtask-of-@parent.TaskId" style="display:none; background:#fafafa;">
                        <td style="padding-left:40px;">
                            <span>@child.Title</span>
                        </td>
                        <td>
                            @foreach (var o in child.TaskAssignments)
                            {
                                <img src="@o.User.AvatarUrl"
                                     style="width:26px;height:26px;object-fit:cover;border-radius:50%;margin-right:2px;"
                                     title="@o.User.FullName" />
                            }
                        </td>
                        <td>

                            @{
                            var statusChild = child.Status switch
                        {
                                PorjectManagement.Models.TaskStatus.ToDo          => "bg-primary",
                                PorjectManagement.Models.TaskStatus.Doing        => "bg-warning text-dark",
                                PorjectManagement.Models.TaskStatus.Completed    => "bg-success",
                                PorjectManagement.Models.TaskStatus.Stuck        => "bg-danger",
                                PorjectManagement.Models.TaskStatus.Not_Started  => "bg-secondary",
                                _ => "bg-light text-dark"
                         };
                        }

                            <span class="badge @statusChild">@child.Status</span>
                        </td>
                        <td>@child.Deadline?.ToString("MMM d")</td>
                        <td>

                            @{
                            var priorityChild = child.Priority switch {
                                PorjectManagement.Models.TaskPriority.Low => "bg-primary", 
                                PorjectManagement.Models.TaskPriority.Medium => "bg-warning text-dark", 
                                PorjectManagement.Models.TaskPriority.High => "bg-dark",
                                PorjectManagement.Models.TaskPriority.Necessary => "bg-danger",
                                _ => "bg-light text-dark" 
                            };

                        }
                            <span class="badge @priorityChild">@child.Priority</span>
                            </td>
                        <td>
                            @if(roleId == 2)
                            {
                            <a asp-controller="Task" asp-action="Edit" asp-route-id="@child.TaskId"
                               class="btn btn-sm btn-edit">
                                <i class="bi bi-pencil-fill"></i>
                            </a>

                            <!-- ASSIGN (SUBTASK) -->
                            <a asp-controller="Task" asp-action="Assign" asp-route-id="@child.TaskId"
                               class="btn btn-sm btn-assign-task">
                                <i class="bi bi-person-plus"></i>
                            </a>

                            <button class="btn btn-sm btn-outline-primary upload-btn"
                                    data-task-id="@child.TaskId"
                                    data-bs-toggle="modal"
                                    data-bs-target="#uploadModal">
                                <i class="bi bi-upload"></i>
                            </button>

                            <button class="btn btn-sm btn-warning delete-btn"
                                    data-task-id="@child.TaskId"
                                    data-task-name="@child.Title">
                                <i class="bi bi-trash"></i>
                            </button>
                            }

                                <!-- 🆕 COMMENT BUTTON - SUBTASK -->
                            <button class="btn btn-sm btn-info comment-btn"
                                    data-task-id="@child.TaskId"
                                    data-task-name="@child.Title"
                                    data-bs-toggle="modal"
                                    data-bs-target="#commentModal">
                                <i class="bi bi-chat-dots"></i> (@child.Comments.Count)
                            </button>

                        </td>
                        <td>
                            @if (child.TaskAttachments != null && child.TaskAttachments.Any())
                            {
                                <div class="output-list">
                            @foreach (var att in child.TaskAttachments.Take(2))
                            {
                                <div class="output-item">
                                     <a href="@att.FilePath" target="_blank" title="@att.FileName">
                                        📎
                                    </a>
                                </div>
                            }

                            @if (child.TaskAttachments.Count > 2)
                            {
                                <small class="text-muted">
                                    +@(child.TaskAttachments.Count - 2) more
                                </small>
                            }
                        </div>

                                <!-- Delete -->
                             <form asp-controller="Task"
                                  asp-action="DeleteAttachment"
                                  method="post"
                                  class="d-inline">
                                <input type="hidden" name="taskId" value="@child.TaskId" />

                                <button type="submit"
                                        class="btn btn-sm btn-outline-danger"
                                        title="Delete attachment"
                                        onclick="return confirm('Delete attachment?');">
                                    <i class="bi bi-x-lg"></i>
                                </button>
                            </form>


                            <!-- Replace -->
                            <form asp-controller="Task"
                                  asp-action="ReplaceAttachment"
                                  method="post"
                                  enctype="multipart/form-data"
                                  class="d-inline">
                                <input type="hidden" name="taskId" value="@child.TaskId" />

                                <label class="btn btn-sm btn-outline-warning mb-0" title="Replace attachment">
                                    <i class="bi bi-arrow-clockwise"></i>
                                    <input type="file"
                                           name="file"
                                           hidden
                                           onchange="this.form.submit()" />
                                </label>
                            </form>

                            }
                            else
                            {
                                <span class="text-muted">No attachment</span>
                            }


                        </td>
                    </tr>   
                }

                <div class="modal fade" id="uploadModal" tabindex="-1">
                    <div class="modal-dialog">
                        <form id="uploadForm" enctype="multipart/form-data" method="post"
                              asp-controller="Task" asp-action="UploadAttachment">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Upload Attachment</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <input type="hidden" name="TaskId" id="uploadTaskId" />
                                    <input type="file" name="file" class="form-control" required />
                                </div>
                                <div class="modal-footer">
                                    <button type="submit" class="btn btn-primary">
                                        Upload
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            }

            <tr>

                        @{
                            var allTasks = (ViewBag.ParentTasks as List<PorjectManagement.Models.Task>)
                            .Concat(ViewBag.SubTasks as List<PorjectManagement.Models.Task>)
                            .ToList();

                            int totalTasks = allTasks.Count == 0 ? 1 : allTasks.Count;

                            int done = allTasks.Count(t => t.Status == PorjectManagement.Models.TaskStatus.Completed);
                            int doing = allTasks.Count(t => t.Status == PorjectManagement.Models.TaskStatus.Doing);
                            int stuck = allTasks.Count(t => t.Status == PorjectManagement.Models.TaskStatus.Stuck);
                            int todo = allTasks.Count(t => t.Status == PorjectManagement.Models.TaskStatus.ToDo);
                            int notStarted = allTasks.Count(t => t.Status == PorjectManagement.Models.TaskStatus.Not_Started);

                            int low = allTasks.Count(t => t.Priority == PorjectManagement.Models.TaskPriority.Low);
                            int medium = allTasks.Count(t => t.Priority == PorjectManagement.Models.TaskPriority.Medium);
                            int high = allTasks.Count(t => t.Priority == PorjectManagement.Models.TaskPriority.High);
                            int necessary = allTasks.Count(t => t.Priority == PorjectManagement.Models.TaskPriority.Necessary);
                        }
                        <td colspan="2"></td>
                        <td>
                        <div class="summary-bar">
                            
                            <div class="summary-segment bg-primary"
                                style="width:@(todo * 100 / totalTasks)%"></div>

                            <div class="summary-segment bg-warning text-dark"
                                style="width:@(doing * 100 / totalTasks)%"></div>

                            <div class="summary-segment bg-success"
                                style="width:@(done * 100 / totalTasks)%"></div>

                            <div class="summary-segment bg-danger"
                                style="width:@(stuck * 100 / totalTasks)%"></div>

                            <div class="summary-segment bg-secondary"
                                style="width:@(notStarted * 100 / totalTasks)%"></div>
                        </div>

                        </td>
                        <td>

                            @{
                            var minDate = allTasks.Where(t => t.Deadline != null).Min(t => t.Deadline);
                            var maxDate = allTasks.Where(t => t.Deadline != null).Max(t => t.Deadline);
                        }

                            @if (minDate != null && maxDate != null)
                        {
                            <span class="badge bg-dark">
                                @minDate.Value.ToString("MMM dd") - @maxDate.Value.ToString("MMM dd")
                            </span>
                        }

                        </td>   
                        <td>
                        <div class="summary-bar">
                            <div class="summary-segment bg-primary"
                                style="width:@(low * 100 / totalTasks)%"></div>

                            <div class="summary-segment bg-warning text-dark"
                                style="width:@(medium * 100 / totalTasks)%"></div>

                            <div class="summary-segment bg-dark"
                                style="width:@(high * 100 / totalTasks)%"></div>

                            <div class="summary-segment bg-danger"
                                style="width:@(necessary * 100 / totalTasks)%"></div>
                        </div>
                        </td>
                        <td colspan="2"></td>

                    </tr>

        </tbody>
    </table>
</div>

<!-- POP UP DELETE NOTI -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Delete task?</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>
                    <strong id="deleteTaskName"></strong>
                </p>
                <p class="text-muted">
                    We'll keep it in your trash for 30 days, and then permanently delete it.
                </p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">
                    Cancel
                </button>
                <button class="btn btn-danger" id="confirmDeleteBtn">
                    Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 🆕 COMMENT MODAL -->
<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="bi bi-chat-dots-fill"></i> Comments - <span id="commentTaskName"></span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="commentsList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                    <!-- Comments will be loaded here -->
                    <p class="text-center text-muted">Loading comments...</p>
                </div>

                <input type="hidden" id="commentTaskId" />

                @if (roleId == 2)
                {
                    <form asp-controller="Task" asp-action="AddComment" method="post">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="taskId" id="commentTaskIdForm" />
                        <div class="input-group">
                            <textarea name="content" class="form-control" rows="2"
                                  placeholder="Write a comment..." required></textarea>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send-fill"></i> Send
                            </button>
                        </div>
                    </form>
                }
                else
                {
                    <div class="alert alert-info mb-0">
                        View comments
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="mt-5">
    <h3>📊 Dashboard</h3>
    <iframe src="/Dashboard/Dashboard?projectId=@projectId&userId=@userId"
            style="width:100%; height:900px; border:none; border-radius:12px; overflow:hidden"></iframe>
</div>

<script>
    const searchButton = document.getElementById("btnSearch");
    const searchInput = document.getElementById("searchInput");

    searchButton.addEventListener("click", function() {
        searchButton.classList.add("d-none");
        searchInput.classList.remove("search-hidden");
        searchInput.focus();
    });

    searchInput.addEventListener("blur", function() {
        searchInput.classList.add("search-hidden");
        searchButton.classList.remove("d-none");
        searchInput.value = "";
    });

    searchInput.addEventListener("keyup", function() {
        const keyword = this.value.toLowerCase();
        const rows = document.querySelectorAll("table tbody tr");

        rows.forEach(row => {
            let matched = false;
            const cells = row.querySelectorAll("td");

            cells.forEach(cell => {
                if (cell.textContent.toLowerCase().includes(keyword)) {
                    matched = true;
                }
            });

            row.style.display = matched ? "" : "none";
        });
    });

    function showNoPermission() {
        alert("You don't have permission to do this!'");
    }
</script>

<script>
    document.querySelectorAll(".toggle-btn").forEach(btn => {
        btn.addEventListener("click", function () {
            let id = this.getAttribute("data-target");
            let rows = document.querySelectorAll(`.subtask-of-${id}`);

            rows.forEach(r => {
                r.style.display = (r.style.display === "none" || r.style.display === "") ? "table-row" : "none";
            });

            this.textContent = (this.textContent.trim() === "▶") ? "▼" : "▶";
        });
    });
</script>
                                        <!-- popup + API DeleteTask -->
<script>
    
    let selectedTaskId = null;
    const deleteModal = new bootstrap.Modal(
        document.getElementById('deleteTaskModal')
    );

    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            selectedTaskId = this.dataset.taskId;
            document.getElementById('deleteTaskName').innerText = this.dataset.taskName;
            deleteModal.show();
        });
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        fetch('/Backlog/DeleteTask', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ taskId: selectedTaskId })
        })
        .then(res => {
            if (res.ok) {
                location.reload();
            } else {
                alert('Delete failed');
            }
        });
    });
</script>

<script>
    document.querySelectorAll('.upload-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            document.getElementById('uploadTaskId').value = this.dataset.taskId;
        });
    });
</script>

<!-- 🆕 SCRIPT ĐỂ LOAD COMMENTS -->
<script>
    document.querySelectorAll('.comment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const taskId = this.dataset.taskId;
            const taskName = this.dataset.taskName;

            document.getElementById('commentTaskId').value = taskId;
            document.getElementById('commentTaskName').innerText = taskName;

            // Load comments
            loadComments(taskId);
            setTimeout(enhanceCommentsForEdit, 300);
        });
    });

    function loadComments(taskId) {
        const commentsContainer = document.getElementById('commentsList');
        commentsContainer.innerHTML = '<p class="text-center text-muted">Loading...</p>';

        fetch(`/api/comments/${taskId}`)
            .then(res => res.json())
            .then(comments => {
                if (comments.length === 0) {
                    commentsContainer.innerHTML = '<p class="text-muted text-center">No comments yet. Be the first to comment!</p>';
                    return;
                }

                let html = '';
                comments.forEach(comment => {
                    const initial = comment.userFullName.charAt(0).toUpperCase();
                    const date = new Date(comment.createdAt).toLocaleString();

                    html += `
                        <div class="comment-item mb-3 p-3 border rounded" data-id="${comment.commentId}" data-user-id="${comment.userId}">
                            <div class="d-flex align-items-start">
                                <div class="avatar-circle bg-secondary text-white me-2"
                                     style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:bold;">
                                    ${initial}
                                </div>
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between">
                                        <strong>${comment.userFullName}</strong>
                                        <small class="text-muted">${date}</small>
                                    </div>
                                    <small class="text-muted">${comment.roleName}</small>
                                    <p class="mt-2 mb-0">${comment.content}</p>
                                </div>
                            </div>
                        </div>
                    `;
                });

                commentsContainer.innerHTML = html;
            })
            .catch(err => {
                commentsContainer.innerHTML = '<p class="text-danger">Failed to load comments.</p>';
            });
    }


</script>
<script>
function enhanceCommentsForEdit() {
    document.querySelectorAll('#commentsList .comment-item').forEach(item => {
            const commentUserId = parseInt(item.dataset.userId);
        if (commentUserId !== CURRENT_USER_ID) return;
        if (item.querySelector('.comment-more')) return;

        item.style.position = 'relative'; 

        const contentP = item.querySelector('p');
        if (!contentP) return;

        const commentId = item.dataset.id;
        const oldText = contentP.innerText;

        // nút ...
        const moreBtn = document.createElement('span');
        moreBtn.innerText = '...';
        moreBtn.classList.add('comment-more');
        moreBtn.style.cursor = 'pointer';
        moreBtn.style.float = 'right';
        moreBtn.style.fontWeight = 'bold';

        contentP.parentElement.prepend(moreBtn);

        // menu nhỏ
        const menu = document.createElement('div');
        menu.style.position = 'absolute';
        menu.style.right = '10px';
        menu.style.top = '25px';
        menu.style.background = '#fff';
        menu.style.border = '1px solid #ccc';
        menu.style.padding = '5px';
        menu.style.display = 'none';
        menu.style.zIndex = '1000';

        const editBtn = document.createElement('div');
        editBtn.innerText = 'Edit';
        editBtn.style.cursor = 'pointer';

        menu.appendChild(editBtn);
        item.appendChild(menu);

        // click ...
        moreBtn.onclick = function (e) {
            e.stopPropagation();
            menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
        };

        // click chỉnh sửa
        editBtn.onclick = function () {
            menu.style.display = 'none';

            contentP.innerHTML = `
                <textarea class="form-control mb-2">${oldText}</textarea>
                <button class="btn btn-sm btn-primary">Send</button>
            `;

            contentP.querySelector('button').onclick = function () {
                const newContent = contentP.querySelector('textarea').value;

                fetch('/Task/UpdateComment', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'same-origin',
                    body: JSON.stringify({
                        commentId: commentId,
                        content: newContent
                    })
                })
                .then(r => {
                    if (r.ok) {
                        const taskId = document.getElementById('commentTaskId').value;
                        loadComments(taskId);
                        setTimeout(enhanceCommentsForEdit, 300);
                    } else {
                        alert('Update failed');
                    }
                });
            };
        };

        // click ra ngoài thì đóng menu
        document.addEventListener('click', function () {
            menu.style.display = 'none';
        });
    });
}
</script>
<script>
    const CURRENT_USER_ID = @(
        Context.Session.GetInt32("UserId") ?? 0
    );
</script>
