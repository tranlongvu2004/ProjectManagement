name: CI/CD ASP.NET MVC

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  build-and-deploy:
    runs-on: windows-latest

    env:
      # ‚úÖ ƒê√öNG theo project b·∫°n cung c·∫•p
      WEB_PROJECT: ProjectManagement.csproj
      PUBLISH_DIR: ${{ github.workspace }}\publish
      IIS_DIR: C:\Deploy\PorjectManagement

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Restore NuGet
      run: nuget restore PorjectManagement.sln

    - name: Build solution
      run: msbuild PorjectManagement.sln /p:Configuration=Release

    - name: List all csproj files
      run: |
        dir -Recurse *.csproj

    # üî• PUBLISH WEB MVC (B·∫ÆT BU·ªòC publish csproj)
    - name: Publish Web MVC
      run: |
        msbuild $env:WEB_PROJECT `
          /p:Configuration=Release `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:DeleteExistingFiles=true `
          /p:PublishDir="$env:PUBLISH_DIR\"

    # üîç VERIFY ‚Äì ƒë·ªÉ ch·∫Øc ch·∫Øn publish ƒë√£ sinh file
    - name: Verify publish output
      run: |
        echo "Publish directory:"
        echo $env:PUBLISH_DIR
        dir $env:PUBLISH_DIR

    # üöÄ DEPLOY TO IIS
    - name: Deploy to IIS
      run: |
        if (!(Test-Path $env:PUBLISH_DIR)) {
          Write-Error "Publish folder NOT FOUND"
          exit 1
        }

        Remove-Item "$env:IIS_DIR\*" -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item "$env:PUBLISH_DIR\*" "$env:IIS_DIR\" -Recurse -Force

    - name: Restart IIS
      run: iisreset
