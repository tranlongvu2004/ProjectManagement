name: CI/CD ASP.NET MVC

on:
  push:
    branches:
      - master

jobs:
  deploy:
    runs-on: windows-latest

    env:
      WEB_PROJECT: PorjectManagement/PorjectManagement.csproj
      PUBLISH_DIR: ${{ github.workspace }}\publish
      IIS_DIR: C:\Deploy\PorjectManagement

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Restore NuGet
      run: nuget restore PorjectManagement.sln

    - name: Build
      run: msbuild PorjectManagement.sln /p:Configuration=Release

    # üî• PUBLISH ƒê√öNG C√ÅCH
    - name: Publish Web MVC
      run: |
        msbuild ${{ env.WEB_PROJECT }} `
          /p:Configuration=Release `
          /p:DeployOnBuild=true `
          /p:WebPublishMethod=FileSystem `
          /p:DeleteExistingFiles=true `
          /p:PublishDir="${{ env.PUBLISH_DIR }}\"

    # üîç DEBUG (B·∫ÆT BU·ªòC ‚Äì ƒë·ªÉ b·∫°n th·∫•y publish th·∫≠t)
    - name: Verify publish output
      run: |
        echo "Publish folder content:"
        dir ${{ env.PUBLISH_DIR }}

    # üöÄ DEPLOY
    - name: Deploy to IIS
      run: |
        if (!(Test-Path "${{ env.PUBLISH_DIR }}")) {
          Write-Error "Publish folder NOT FOUND"
          exit 1
        }

        Remove-Item "${{ env.IIS_DIR }}\*" -Recurse -Force -ErrorAction SilentlyContinue
        Copy-Item "${{ env.PUBLISH_DIR }}\*" "${{ env.IIS_DIR }}\" -Recurse -Force

    - name: Restart IIS
      run: iisreset
